---
- name: Check if dnsmasq service is running
  # noqa: command-instead-of-module
  become: true
  become_flags: "su - -c"
  become_method: ansible.builtin.sudo
  ansible.builtin.command:
    cmd: "systemctl is-active dnsmasq"
  register: dnsmasq_status
  failed_when: false
  changed_when: false
  when:
    - distro_debian_based|bool

- name: Fail if dnsmasq service conflicts with libvirt
  ansible.builtin.fail:
    msg: |
      dnsmasq service is running and will conflict with libvirt networking.
      The libvirt default network requires control of DHCP/DNS services.
      Disable dnsmasq with: sudo systemctl disable --now dnsmasq
  when:
    - distro_debian_based|bool
    - dnsmasq_status.rc == 0

- name: Check if libvirt default network is running
  become: true
  become_flags: "su - -c"
  become_method: ansible.builtin.sudo
  environment:
    LIBVIRT_DEFAULT_URI: "{{ libvirt_uri }}"
  ansible.builtin.shell: virsh net-list | grep -q default
  register: libvirt_default_net
  ignore_errors: true
  changed_when: false
  when:
    - libvirt_uri_system|bool

- name: Start the libvirt default network
  become: true
  become_flags: "su - -c"
  become_method: ansible.builtin.sudo
  environment:
    LIBVIRT_DEFAULT_URI: "{{ libvirt_uri }}"
  ansible.builtin.command:
    cmd: "virsh net-start default"
  changed_when: true
  when:
    - libvirt_uri_system|bool
    - libvirt_default_net.rc != 0
