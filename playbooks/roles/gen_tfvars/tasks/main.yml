---
- name: Import optional extra_args file
  ansible.builtin.include_vars: "{{ item }}"
  ignore_errors: true
  with_first_found:
    - files:
        - "../extra_vars.yml"
        - "../extra_vars.yaml"
        - "../extra_vars.json"
      skip: true
  tags: vars

- name: Verify Terraform variable template file exists {{ kdevops_terraform_tfvars_template_full_path }}
  ansible.builtin.stat:
    path: "{{ kdevops_nodes_template_full_path }}"
  register: terraform_tfvars_template

- name: Get our user
  ansible.builtin.command: "whoami"
  register: my_user

- name: Get our primary group
  ansible.builtin.command: "id -g -n"
  register: my_group

- name: Check if {{ kdevops_terraform_tfvars }} exists already
  ansible.builtin.stat:
    path: "{{ topdir_path }}/{{ kdevops_terraform_tfvars }}"
  register: kdevops_tfvars_dest

- name: Find dynamic Kconfig files for {{ kdevops_terraform_provider }}
  ansible.builtin.find:
    paths: "{{ topdir_path }}/terraform/{{ kdevops_terraform_provider }}/kconfigs"
    patterns: "Kconfig*.generated"
  register: provider_kconfig_files
  when:
    - kdevops_enable_terraform

- name: Check if any dynamic Kconfig files are empty
  ansible.builtin.fail:
    msg: |
      ERROR: Dynamic cloud configuration not generated or incomplete.

      Found {{ provider_kconfig_files.matched }} dynamic Kconfig file(s) for {{ kdevops_terraform_provider }},
      but at least one is empty ({{ item.path }}).

      Before running 'make' or 'make bringup', you must generate the
      dynamic cloud configuration by running:

          make cloud-config

      For more information, run 'make help' and see the cloud-config
      targets section.
  when:
    - kdevops_enable_terraform
    - provider_kconfig_files.matched > 0
    - item.size == 0
  loop: "{{ provider_kconfig_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: Ensure proper permission on {{ kdevops_terraform_tfvars }}
  become: true
  become_flags: "su - -c"
  become_method: sudo
  ansible.builtin.file:
    path: "{{ topdir_path }}/{{ kdevops_terraform_tfvars }}"
    owner: "{{ my_user.stdout }}"
    group: "{{ my_group.stdout }}"
  when:
    - kdevops_tfvars_dest.stat.exists

- name: Generate the terraform variables file file using {{ kdevops_terraform_tfvars }} as jinja2 source template
  tags: ["nodes"]
  vars:
    tfvars_template: "{{ kdevops_terraform_tfvars_template }}"
  ansible.builtin.template:
    src: "{{ tfvars_template }}"
    dest: "{{ topdir_path }}/{{ kdevops_terraform_tfvars }}"
    force: true
  when:
    - kdevops_enable_terraform
    - terraform_tfvars_template.stat.exists
