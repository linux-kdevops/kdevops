---
- name: Import optional extra_args file
  ansible.builtin.include_vars: "{{ item }}"
  ignore_errors: true
  with_first_found:
    - files:
        - "../extra_vars.yml"
        - "../extra_vars.yaml"
        - "../extra_vars.json"
      skip: true
  tags: vars

- name: Verify Terraform variable template file exists {{ kdevops_terraform_tfvars_template_full_path }}
  ansible.builtin.stat:
    path: "{{ kdevops_nodes_template_full_path }}"
  register: terraform_tfvars_template

- name: Get our user
  ansible.builtin.command: "whoami"
  register: my_user

- name: Get our primary group
  ansible.builtin.command: "id -g -n"
  register: my_group

- name: Check if {{ kdevops_terraform_tfvars }} exists already
  ansible.builtin.stat:
    path: "{{ topdir_path }}/{{ kdevops_terraform_tfvars }}"
  register: kdevops_tfvars_dest

- name: Ensure proper permission on {{ kdevops_terraform_tfvars }}
  become: true
  become_flags: "su - -c"
  become_method: sudo
  ansible.builtin.file:
    path: "{{ topdir_path }}/{{ kdevops_terraform_tfvars }}"
    owner: "{{ my_user.stdout }}"
    group: "{{ my_group.stdout }}"
  when:
    - kdevops_tfvars_dest.stat.exists

# Map GPU instance configurations to actual instance types
- name: Set AWS instance type based on configuration
  ansible.builtin.set_fact:
    terraform_aws_instance_type: "{{ 'g5.xlarge' if terraform_aws_instance_g5_xlarge | default(false) | bool else
                                       'g5.2xlarge' if terraform_aws_instance_g5_2xlarge | default(false) | bool else
                                       'g5.4xlarge' if terraform_aws_instance_g5_4xlarge | default(false) | bool else
                                       'g5.8xlarge' if terraform_aws_instance_g5_8xlarge | default(false) | bool else
                                       'g5.12xlarge' if terraform_aws_instance_g5_12xlarge | default(false) | bool else
                                       'g5.16xlarge' if terraform_aws_instance_g5_16xlarge | default(false) | bool else
                                       'g5.24xlarge' if terraform_aws_instance_g5_24xlarge | default(false) | bool else
                                       'g5.48xlarge' if terraform_aws_instance_g5_48xlarge | default(false) | bool else
                                       'p4d.24xlarge' if terraform_aws_instance_p4d_24xlarge | default(false) | bool else
                                       'p5.4xlarge' if terraform_aws_instance_p5_4xlarge | default(false) | bool else
                                       'p5.48xlarge' if terraform_aws_instance_p5_48xlarge | default(false) | bool else
                                       terraform_aws_instance_type | default('t2.micro') }}"
  when: kdevops_terraform_provider == "aws"

- name: Generate the terraform variables file file using {{ kdevops_terraform_tfvars }} as jinja2 source template
  tags: ["nodes"]
  vars:
    tfvars_template: "{{ kdevops_terraform_tfvars_template }}"
  ansible.builtin.template:
    src: "{{ tfvars_template }}"
    dest: "{{ topdir_path }}/{{ kdevops_terraform_tfvars }}"
    force: true
  when:
    - kdevops_enable_terraform
    - terraform_tfvars_template.stat.exists
