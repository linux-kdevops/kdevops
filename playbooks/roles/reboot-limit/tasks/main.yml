---
- name: Import optional extra_args file
  include_vars: "{{ item }}"
  ignore_errors: yes
  with_first_found:
    - files:
      - "../extra_vars.yml"
      - "../extra_vars.yaml"
      - "../extra_vars.json"
      skip: true
  tags: vars

- include_role:
    name: create_data_partition
  tags: [ 'data_partition' ]

- name: Install dependencies for reboot-limit
  include_tasks: install-deps/main.yml
  tags: [ 'install', 'deps' ]

- name: Create the reboot-limit data collection directory for each host
  become: yes
  become_method: sudo
  file:
    path: "{{ reboot_limit_data }}/{{ ansible_ssh_host }}"
    state: directory
  when: not reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'install', 'first_run' ]

- name: Create the regular reboot data collection directory for comparison mode
  become: yes
  become_method: sudo
  file:
    path: "{{ reboot_limit_data_regular }}/{{ ansible_ssh_host }}"
    state: directory
  when: reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'install', 'first_run' ]

- name: Create the kexec reboot data collection directory for comparison mode
  become: yes
  become_method: sudo
  file:
    path: "{{ reboot_limit_data_kexec }}/{{ ansible_ssh_host }}"
    state: directory
  when: reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'install', 'first_run' ]

- name: Set the file to collect systemctl-analyze results
  become: yes
  become_method: sudo
  set_fact:
    reboot_limit_analyze_file: "{{ reboot_limit_data}}/{{ ansible_ssh_host }}/{{ reboot_limits_systemctl_analyze_log }}"
  tags: [ 'vars' ]

- name: Set the file to collect the reboot count
  become: yes
  become_method: sudo
  set_fact:
    reboot_limit_count_file: "{{ reboot_limit_data}}/{{ ansible_ssh_host }}/{{ reboot_limits_count_log }}"
  tags: [ 'read_count', 'vars' ]

- name: Delete old results directory files if a reset was called (single mode)
  become: yes
  become_method: sudo
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ reboot_limit_analyze_file }}"
    - "{{ reboot_limit_count_file }}"
  loop_control:
    label: "{{ item | regex_replace(reboot_limit_data | regex_escape()) | regex_replace('^/', '') }}"
  when: not reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'reset' ]

- name: Delete old results directory files if a reset was called (comparison mode - regular)
  become: yes
  become_method: sudo
  file:
    path: "{{ reboot_limit_data_regular }}/{{ ansible_ssh_host }}"
    state: absent
  when: reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'reset' ]

- name: Delete old results directory files if a reset was called (comparison mode - kexec)
  become: yes
  become_method: sudo
  file:
    path: "{{ reboot_limit_data_kexec }}/{{ ansible_ssh_host }}"
    state: absent
  when: reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'reset' ]

- name: Set the path where we collect our local reboot-limit results
  set_fact:
    reboot_limit_local_results_dir: "../workflows/demos/reboot-limit/results"
  tags: [ 'vars' ]

- name: Clean up our localhost results directory and files as we are on boot number {{ reboot_limit_count }}
  local_action: file path="{{ reboot_limit_local_results_dir }}/" state=absent
  run_once: true
  tags: [ 'clean_local_results', 'first_run' ]

- name: Create the local results directory
  local_action: file path="{{ reboot_limit_local_results_dir }}/" state=directory
  run_once: true
  tags: [ 'first_run' ]

- name: Run the reboot loop (single mode)
  include_tasks: do-reboot.yml
  with_sequence: count={{ reboot_limit_max }}
  loop_control:
    loop_var: reboot_num
  when: not reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'run_tests' ]

- name: Run the reboot comparison loop (both regular and kexec)
  include_tasks: do-reboot-compare.yml
  with_sequence: count={{ reboot_limit_max }}
  loop_control:
    loop_var: reboot_num
  when: reboot_limit_compare_both_enabled|default(false)|bool
  tags: [ 'run_tests' ]

- name: Copy the latest results over when we're done (single mode)
  tags: [ 'copy_results' ]
  become: yes
  become_flags: 'su - -c'
  become_method: sudo
  fetch:
    src: "{{ item }}"
    dest: "{{ reboot_limit_local_results_dir }}/{{ item | regex_replace(reboot_limit_data | regex_escape()) | regex_replace('^/', '') }}"
    flat: yes
  with_items:
    - "{{ reboot_limit_analyze_file }}"
    - "{{ reboot_limit_count_file }}"
  loop_control:
    label: "{{ item | regex_replace(reboot_limit_data | regex_escape()) | regex_replace('^/', '') }}"
  when: not reboot_limit_compare_both_enabled|default(false)|bool

- name: Copy the regular reboot results in comparison mode
  tags: [ 'copy_results' ]
  become: yes
  become_flags: 'su - -c'
  become_method: sudo
  fetch:
    src: "{{ reboot_limit_data_regular }}/{{ ansible_ssh_host }}/{{ item }}"
    dest: "{{ reboot_limit_local_results_dir }}/regular/{{ ansible_ssh_host }}/{{ item }}"
    flat: yes
  with_items:
    - "{{ reboot_limits_systemctl_analyze_log }}"
    - "{{ reboot_limits_count_log }}"
  when: reboot_limit_compare_both_enabled|default(false)|bool

- name: Copy the kexec reboot results in comparison mode
  tags: [ 'copy_results' ]
  become: yes
  become_flags: 'su - -c'
  become_method: sudo
  fetch:
    src: "{{ reboot_limit_data_kexec }}/{{ ansible_ssh_host }}/{{ item }}"
    dest: "{{ reboot_limit_local_results_dir }}/kexec/{{ ansible_ssh_host }}/{{ item }}"
    flat: yes
  with_items:
    - "{{ reboot_limits_systemctl_analyze_log }}"
    - "{{ reboot_limits_count_log }}"
  when: reboot_limit_compare_both_enabled|default(false)|bool
