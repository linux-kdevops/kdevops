services:
  etcd:
    container_name: {{ ai_vector_db_milvus_etcd_container_name }}
    image: {{ ai_vector_db_milvus_etcd_container_image_string }}
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - {{ ai_vector_db_milvus_docker_etcd_data_path }}:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    # Health check disabled - etcd container doesn't have curl or etcdctl in PATH
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:2379/health"]
    #   interval: 30s
    #   timeout: 20s
    #   retries: 3
    restart: unless-stopped

  minio:
    container_name: {{ ai_vector_db_milvus_minio_container_name }}
    image: {{ ai_vector_db_milvus_minio_container_image_string }}
    environment:
      MINIO_ACCESS_KEY: {{ ai_vector_db_milvus_minio_access_key }}
      MINIO_SECRET_KEY: {{ ai_vector_db_milvus_minio_secret_key }}
    volumes:
      - {{ ai_vector_db_milvus_docker_minio_data_path }}:/minio_data
    command: minio server /minio_data --console-address ":{{ ai_vector_db_milvus_minio_console_port }}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ ai_vector_db_milvus_minio_api_port }}/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped
    ports:
      - "{{ ai_vector_db_milvus_minio_api_port }}:{{ ai_vector_db_milvus_minio_api_port }}"
      - "{{ ai_vector_db_milvus_minio_console_port }}:{{ ai_vector_db_milvus_minio_console_port }}"

  milvus:
    container_name: {{ ai_vector_db_milvus_container_name }}
    image: {{ ai_vector_db_milvus_container_image_string }}
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:{{ ai_vector_db_milvus_etcd_client_port }}
      MINIO_ADDRESS: minio:{{ ai_vector_db_milvus_minio_api_port }}
    volumes:
      - {{ ai_vector_db_milvus_docker_data_path }}:/var/lib/milvus
    depends_on:
      - etcd
      - minio
    ports:
      - "{{ ai_vector_db_milvus_port }}:19530"
      - "{{ ai_vector_db_milvus_web_ui_port }}:9091"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: {{ ai_vector_db_milvus_memory_limit }}
          cpus: '{{ ai_vector_db_milvus_cpu_limit }}'

networks:
  default:
    name: {{ ai_vector_db_milvus_docker_network_name }}
