#!/bin/bash
# Persistent DHCP lease caching - ISC dhclient exit hook
# This hook restores cached DHCP configuration if DHCP fails after reboot
# Managed by kdevops - dhclient_cache role

CACHE_DIR="/var/lib/dhcp/cache"
CACHE_FILE="${CACHE_DIR}/dhclient.${interface}.cached-lease"
CACHE_TIMEOUT={{ dhclient_cache_timeout }}

# Only attempt cache restore on TIMEOUT or FAIL events
case "${reason}" in
    TIMEOUT|FAIL)
        if [ -f "${CACHE_FILE}" ]; then
            # Source the cached lease
            source "${CACHE_FILE}"

            # Check if cache is still valid (within timeout period)
            current_timestamp=$(date +%s)
            cache_age=$((current_timestamp - cache_timestamp))

            if [ ${cache_age} -lt ${CACHE_TIMEOUT} ]; then
                logger -t kdevops-dhcp-cache "DHCP ${reason} for ${interface}, restoring from cache (age: ${cache_age}s)"

                # Apply cached IP configuration
                if [ -n "${new_ip_address}" ]; then
                    ip addr flush dev "${interface}" 2>/dev/null || true
                    ip addr add "${new_ip_address}/${new_subnet_mask}" dev "${interface}"

                    if [ -n "${new_routers}" ]; then
                        ip route add default via "${new_routers}" dev "${interface}" 2>/dev/null || true
                    fi

                    if [ -n "${new_domain_name_servers}" ]; then
                        # Update resolv.conf with cached DNS servers
                        {
                            echo "# Generated by dhclient-azure-cache from cached lease"
                            echo "# Cached DNS servers restored after DHCP ${reason}"
                            for nameserver in ${new_domain_name_servers}; do
                                echo "nameserver ${nameserver}"
                            done
                        } > /etc/resolv.conf
                    fi

                    logger -t kdevops-dhcp-cache "Successfully restored cached IP configuration: ${new_ip_address}"

                    # Set exit code to indicate we handled the failure
                    exit 0
                fi
            else
                logger -t kdevops-dhcp-cache "Cached lease for ${interface} expired (age: ${cache_age}s > ${CACHE_TIMEOUT}s)"
            fi
        else
            logger -t kdevops-dhcp-cache "No cached lease found for ${interface} after DHCP ${reason}"
        fi
        ;;
esac
