#!/bin/bash
# Persistent DHCP caching - wicked extension script
# This script saves successful DHCP configuration and restores on failure
# Managed by kdevops - dhclient_cache role

INTERFACE="$1"
ACTION="$2"
CACHE_DIR="/var/lib/wicked/cache"
CACHE_FILE="${CACHE_DIR}/${INTERFACE}.cached-config"
CACHE_TIMEOUT={{ dhclient_cache_timeout }}

# Ensure cache directory exists
mkdir -p "${CACHE_DIR}"

case "${ACTION}" in
    lease-acquired|lease-renewed)
        # Save current network configuration to cache
        WICKED_INFO=$(wicked show "${INTERFACE}" 2>/dev/null)
        IP_ADDR=$(echo "${WICKED_INFO}" | grep -oP 'addr.*inet \K[0-9./]+')
        GATEWAY=$(echo "${WICKED_INFO}" | grep -oP 'route.*default.*via \K[0-9.]+')
        DNS=$(echo "${WICKED_INFO}" | grep -oP 'DNS.*\K[0-9.]+' | tr '\n' ' ')

        if [ -n "${IP_ADDR}" ]; then
            {
                echo "# Cached wicked DHCP configuration for ${INTERFACE}"
                echo "# Cached at: $(date)"
                echo "# Cache timeout: ${CACHE_TIMEOUT} seconds"
                echo "IP_ADDR=\"${IP_ADDR}\""
                echo "GATEWAY=\"${GATEWAY}\""
                echo "DNS=\"${DNS}\""
                echo "cache_timestamp=\"$(date +%s)\""
            } > "${CACHE_FILE}"
            chmod 644 "${CACHE_FILE}"
            logger -t kdevops-dhcp-cache "Saved wicked DHCP config to cache for ${INTERFACE}: ${IP_ADDR}"
        fi
        ;;

    link-down|lease-lost)
        # Try to restore from cache if DHCP fails
        if [ -f "${CACHE_FILE}" ]; then
            source "${CACHE_FILE}"

            # Check if cache is still valid
            current_timestamp=$(date +%s)
            cache_age=$((current_timestamp - cache_timestamp))

            if [ ${cache_age} -lt ${CACHE_TIMEOUT} ]; then
                logger -t kdevops-dhcp-cache "Wicked ${ACTION} for ${INTERFACE}, restoring from cache (age: ${cache_age}s)"

                # Apply cached configuration using wicked
                if [ -n "${IP_ADDR}" ]; then
                    ip addr add "${IP_ADDR}" dev "${INTERFACE}" 2>/dev/null
                    [ -n "${GATEWAY}" ] && ip route add default via "${GATEWAY}" dev "${INTERFACE}" 2>/dev/null

                    # Update resolv.conf
                    if [ -n "${DNS}" ]; then
                        {
                            echo "# Generated by kdevops dhcp cache from wicked"
                            for nameserver in ${DNS}; do
                                echo "nameserver ${nameserver}"
                            done
                        } > /etc/resolv.conf
                    fi

                    logger -t kdevops-dhcp-cache "Successfully restored cached wicked configuration: ${IP_ADDR}"
                fi
            else
                logger -t kdevops-dhcp-cache "Cached config for ${INTERFACE} expired (age: ${cache_age}s > ${CACHE_TIMEOUT}s)"
            fi
        else
            logger -t kdevops-dhcp-cache "No cached config found for ${INTERFACE} after ${ACTION}"
        fi
        ;;
esac
