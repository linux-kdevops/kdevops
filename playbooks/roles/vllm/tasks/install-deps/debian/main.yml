---
- name: Update apt cache
  become: true
  become_method: sudo
  ansible.builtin.apt:
    update_cache: true
  tags: vllm

- name: Check if docker-ce is already installed
  become: true
  become_method: sudo
  ansible.builtin.command: dpkg -l docker-ce
  register: docker_ce_check
  failed_when: false
  changed_when: false
  tags: ["vllm", "deps"]

- name: Install vLLM system dependencies (with docker.io if docker-ce not present)
  become: true
  become_method: sudo
  ansible.builtin.apt:
    name:
      - git
      - curl
      - wget
      - python3
      - python3-venv
      - docker.io
      - ca-certificates
      - gnupg
      - lsb-release
      - apt-transport-https
      - iptables
      - conntrack
    state: present
    update_cache: true
  when: docker_ce_check.rc != 0
  tags: ["vllm", "deps"]

- name: Install vLLM system dependencies (without docker.io when docker-ce present)
  become: true
  become_method: sudo
  ansible.builtin.apt:
    name:
      - git
      - curl
      - wget
      - python3
      - python3-venv
      - ca-certificates
      - gnupg
      - lsb-release
      - apt-transport-https
      - iptables
      - conntrack
    state: present
    update_cache: true
  when: docker_ce_check.rc == 0
  tags: ["vllm", "deps"]

- name: Install Python development dependencies
  become: true
  become_method: sudo
  ansible.builtin.apt:
    name:
      - python3-dev
      - python3-setuptools
      - python3-wheel
      - build-essential
    state: present
  tags: ["vllm", "deps"]

- name: Install Python benchmarking dependencies
  become: true
  become_method: sudo
  ansible.builtin.apt:
    name:
      - python3-aiohttp
      - python3-numpy
      - python3-pandas
      - python3-matplotlib
    state: present
  tags: ["vllm", "deps", "benchmark"]

- name: Install Python Kubernetes client library
  become: true
  become_method: sudo
  ansible.builtin.apt:
    name:
      - python3-kubernetes
    state: present
  tags: ["vllm", "deps"]

- name: Add current user to docker group
  become: true
  become_method: sudo
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: docker
    append: yes
  tags: ["vllm", "deps", "docker-config"]
