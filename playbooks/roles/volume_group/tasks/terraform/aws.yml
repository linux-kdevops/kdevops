---
#
# To guarantee idempotency, these steps have to generate the exact
# same physical_volumes list every time they are run.
#
# On AWS, normally the root device is /dev/nvme0n1 and the data
# device is /dev/nvme1n1. However, this is not always the case:
# block volumes can be attached to an instance in any order, thus
# may appear as any device named /dev/nvmeNn1. Thus these names
# are not fixed and cannot be depended upon to locate specific
# devices or their content.
#
# Instead, rely on a directory created by a udev rule to find the
# EBS block devices attached on behalf of kdevops. The rule
# guarantees the symlinks names always point to the same block
# device.
#

- name: Retrieve list of symlinks residing under /dev/disk/kdevops
  ansible.builtin.find:
    file_type: link
    paths: "/dev/disk/kdevops"
    excludes: "{{ data_device | basename }}"
  register: find_output

- name: Extract device paths from find output
  ansible.builtin.set_fact:
    physical_volumes: "{{ find_output.files | map(attribute='path') | list }}"
