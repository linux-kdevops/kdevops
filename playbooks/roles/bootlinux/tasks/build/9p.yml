---
- name: Install dependencies to build the Linux kernel
  delegate_to: localhost
  run_once: true
  ansible.builtin.import_tasks:
    file: install-deps/main.yml

- name: Install b4 on host
  become: yes
  become_method: sudo
  pip:
    name:
      - b4
  when:
    - target_linux_install_b4 is defined
    - target_linux_install_b4
    - ansible_facts['os_family']|lower != 'debian'
  run_once: true
  delegate_to: localhost

- name: Add safe exception for a clone
  command: "git config --global --add safe.directory {{ target_linux_git }}"
  tags: [ 'clone']
  when:
    - target_linux_git is string and target_linux_git.startswith('/')
  run_once: true
  delegate_to: localhost

- name: Check if target directory exists
  stat:
    path: "{{ bootlinux_9p_host_path }}"
  register: target_directory_stat
  run_once: true
  delegate_to: localhost

- name: Check if .git directory exists in target path
  stat:
    path: "{{ bootlinux_9p_host_path }}/.git"
  register: git_directory_stat
  run_once: true
  delegate_to: localhost
  when:
    - target_directory_stat.stat.exists

- name: Infer that git clone is needed when .git doesn't exist
  set_fact:
    needs_git_clone: true
  when:
    - target_directory_stat.stat.exists
    - not git_directory_stat.stat.exists
  run_once: true
  delegate_to: localhost

- name: Set needs_git_clone when directory doesn't exist
  set_fact:
    needs_git_clone: true
  when:
    - not target_directory_stat.stat.exists
  run_once: true
  delegate_to: localhost

- name: Set needs_git_clone to false when .git exists
  set_fact:
    needs_git_clone: false
  when:
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists
  run_once: true
  delegate_to: localhost

- name: Verify target git ref exists before cloning
  command: "git ls-remote {{ target_linux_git }} {{ active_linux_ref | default(target_linux_ref) }}"
  register: ref_check
  run_once: true
  delegate_to: localhost
  when:
    - needs_git_clone|bool
  tags: [ 'clone']

- name: Fail if git ref does not exist
  fail:
    msg: |
      Failed to verify git ref '{{ active_linux_ref | default(target_linux_ref) }}' exists in repository '{{ target_linux_git }}'.

      This typically happens when:
      1. The ref (branch/tag/commit) doesn't exist in the repository
      2. You're using A/B testing with a shallow clone that doesn't contain the required ref
      3. The repository URL is incorrect or inaccessible

      Please verify:
      - The ref '{{ active_linux_ref | default(target_linux_ref) }}' exists in the repository
      - If using A/B testing with different refs, ensure shallow cloning is disabled
      - The repository URL '{{ target_linux_git }}' is correct and accessible
  when:
    - needs_git_clone|bool
    - ref_check.rc != 0
  run_once: true
  delegate_to: localhost

- name: Check if git tree is dirty
  command: "git -C {{ bootlinux_9p_host_path }} status --porcelain"
  register: git_status
  changed_when: false
  failed_when: false
  run_once: true
  delegate_to: localhost
  when:
    - not needs_git_clone|bool
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists

- name: Fail if git tree has local modifications
  fail:
    msg: |
      Local modifications exist in the destination: {{ bootlinux_9p_host_path }}

      The git tree is dirty with uncommitted changes. This prevents safe git operations.

      To resolve this, you can:
      1. Commit or stash your changes in {{ bootlinux_9p_host_path }}
      2. Reset the tree with: git -C {{ bootlinux_9p_host_path }} reset --hard
      3. Remove the directory and let kdevops clone fresh: rm -rf {{ bootlinux_9p_host_path }}

      Modified files:
      {{ git_status.stdout }}
  when:
    - not needs_git_clone|bool
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists
    - git_status.stdout | length > 0
  run_once: true
  delegate_to: localhost

- name: git clone {{ target_linux_tree }} on the control node
  git:
    repo: "{{ target_linux_git }}"
    dest: "{{ bootlinux_9p_host_path }}"
    update: yes
    depth: "{{ target_linux_shallow_depth }}"
    version: "{{ active_linux_ref | default(target_linux_ref) }}"
  retries: 3
  delay: 5
  register: result
  until: not result.failed
  tags: [ 'clone']
  when:
    - needs_git_clone|bool
  run_once: true
  delegate_to: localhost

- name: Get current git ref when git exists but clone wasn't needed
  command: "git -C {{ bootlinux_9p_host_path }} rev-parse HEAD"
  register: current_ref
  changed_when: false
  run_once: true
  delegate_to: localhost
  when:
    - not needs_git_clone|bool
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists

- name: Get target ref SHA
  command: "git -C {{ bootlinux_9p_host_path }} rev-parse {{ active_linux_ref | default(target_linux_ref) }}"
  register: target_ref_sha
  changed_when: false
  failed_when: false
  run_once: true
  delegate_to: localhost
  when:
    - not needs_git_clone|bool
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists

- name: Fetch updates if target ref doesn't exist locally
  command: "git -C {{ bootlinux_9p_host_path }} fetch origin"
  run_once: true
  delegate_to: localhost
  when:
    - not needs_git_clone|bool
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists
    - target_ref_sha.rc != 0

- name: Get target ref SHA after fetch
  command: "git -C {{ bootlinux_9p_host_path }} rev-parse {{ active_linux_ref | default(target_linux_ref) }}"
  register: target_ref_sha_after_fetch
  changed_when: false
  run_once: true
  delegate_to: localhost
  when:
    - not needs_git_clone|bool
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists
    - target_ref_sha.rc != 0

- name: Checkout target ref if not on correct ref
  command: "git -C {{ bootlinux_9p_host_path }} checkout {{ active_linux_ref | default(target_linux_ref) }}"
  run_once: true
  delegate_to: localhost
  when:
    - not needs_git_clone|bool
    - target_directory_stat.stat.exists
    - git_directory_stat.stat.exists
    - (target_ref_sha.rc == 0 and current_ref.stdout != target_ref_sha.stdout) or
      (target_ref_sha.rc != 0 and target_ref_sha_after_fetch is defined and target_ref_sha_after_fetch.rc == 0)

- name: Copy kernel delta if requested on the control node
  template:
    src: "{{ target_linux_extra_patch }}"
    dest: "{{ bootlinux_9p_host_path }}/{{ target_linux_extra_patch }}"
    mode: 0644
  when:
    - target_linux_extra_patch is defined
  run_once: true
  delegate_to: localhost

- name: Apply kernel delta if requested on the control node
  command: "git am {{ target_linux_extra_patch }}"
  args:
    chdir: "{{ bootlinux_9p_host_path }}"
  when:
    - target_linux_extra_patch is defined
  run_once: true
  delegate_to: localhost

- name: Variable values
  debug:
    msg: "{{ target_linux_apply_patch_message_id }}"
  when:
    - target_linux_apply_patch_message_id is defined

- name: Apply message patch set if requested on the control node
  shell: b4 am -o - {{target_linux_apply_patch_message_id}} | git am
  args:
    chdir: "{{ bootlinux_9p_host_path }}"
  when:
    - target_linux_apply_patch_message_id is defined
    - target_linux_apply_patch_message_id | length > 0
    - bootlinux_b4_am_this_host|bool
  run_once: true
  delegate_to: localhost

- name: Copy configuration for Linux {{ target_linux_tree }} on the control node
  template:
    src: "{{ linux_config }}"
    dest: "{{ bootlinux_9p_host_path }}/.config"
    mode: 0644
  run_once: true
  delegate_to: localhost

- name: Set kernel localversion if requested on the control node
  shell: "echo {{ active_linux_localversion | default(target_linux_localversion) }} > {{ bootlinux_9p_host_path }}/localversion"
  when:
    - (active_linux_localversion is defined and active_linux_localversion != "") or (target_linux_localversion is defined and target_linux_localversion != "")
  run_once: true
  delegate_to: localhost

- name: Configure Linux {{ target_linux_tree }} on the control node
  shell: |
    set -o pipefail
    yes "" | make oldconfig
  register: configure_done
  changed_when: configure_done.rc == 0 or configure_done.rc == 141
  failed_when: configure_done.rc != 0 and configure_done.rc != 141
  args:
    chdir: "{{ bootlinux_9p_host_path }}"
    executable: /bin/bash
  run_once: true
  delegate_to: localhost

- name: Get nproc on the control node
  command: "{{ num_jobs }}"
  tags: [ 'build-linux', 'cxl-build' ]
  register: nproc_9p
  run_once: true
  delegate_to: localhost

- name: Get kernelversion
  make:
    chdir: "{{ bootlinux_9p_host_path }}"
    target: kernelversion
  register: target_linux_kernelversion
  tags: [ 'build-linux' ]
  when:
    - (active_linux_kernelrelease | default(target_linux_kernelrelease)) | length > 0
  run_once: true
  delegate_to: localhost

- name: Generate user kernelrelease {{ target_linux_kernelversion.stdout }}-{{ active_linux_kernelrelease | default(target_linux_kernelrelease) }}
  set_fact:
    target_user_kernelrelease: "{{ target_linux_kernelversion.stdout }}-{{ active_linux_kernelrelease | default(target_linux_kernelrelease) }}"
  tags: [ 'build-linux' ]
  when:
    - (active_linux_kernelrelease | default(target_linux_kernelrelease)) | length > 0
  run_once: true
  delegate_to: localhost

- name: Build {{ target_linux_tree }} {{ target_user_kernelrelease }} on the control node using {{ nproc_9p.stdout }} threads
  make:
    jobs: "{{ nproc_9p.stdout }}"
    chdir: "{{ bootlinux_9p_host_path }}"
    params:
      KERNELRELEASE={{ target_user_kernelrelease }}
  tags: [ 'build-linux' ]
  when:
    - (active_linux_kernelrelease | default(target_linux_kernelrelease)) | length > 0
  run_once: true
  delegate_to: localhost

- name: Build {{ target_linux_tree }} on the control node using {{ nproc_9p.stdout }} threads
  make:
    jobs: "{{ nproc_9p.stdout }}"
    chdir: "{{ bootlinux_9p_host_path }}"
  tags: [ 'build-linux' ]
  when:
    - (active_linux_kernelrelease | default(target_linux_kernelrelease)) | length == 0
  run_once: true
  delegate_to: localhost

- name: Build {{ target_linux_tree }} cxl_test on the control node using {{ nproc_9p.stdout }} threads
  make:
    jobs: "{{ nproc_9p.stdout }}"
    chdir: "{{ bootlinux_9p_host_path }}"
    params:
      M: "tools/testing/cxl"
  tags: [ 'build-linux', 'cxl-build' ]
  when:
    - bootlinux_cxl_test|bool
  run_once: true
  delegate_to: localhost

- name: See if snake-oil cert file is present on host
  stat:
    path: "{{ bootlinux_9p_host_path }}/certs/signing_key.pem"
  register: snaik_oil_file_9p
  tags: [ 'build-linux' ]
  run_once: true
  delegate_to: localhost

- name: Ensure we allow world to read the snake oil in case of NFS or 9p read only usage
  file:
    path: "{{ bootlinux_9p_host_path }}/certs/signing_key.pem"
    mode: "0755"
  tags: [ 'build-linux' ]
  when:
    - snaik_oil_file_9p.stat.exists
  run_once: true
  delegate_to: localhost
