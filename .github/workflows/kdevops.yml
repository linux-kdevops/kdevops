# SPDX-License-Identifier: GPL-2.0
---
name: Run kdevops CI Workflow - Push/PR/Manual/Schedule

on:
  schedule:
    - cron: '0 14 * * *'  # Daily at 2 PM UTC
  push:
    branches:
      - main
      - 'ci-testing/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ci_workflow:
        description: "CI Workflow (parent workflows expand to multiple jobs)"
        required: true
        default: 'blktests_nvme'
        type: choice
        options:
          # === PARENT WORKFLOWS (expand to multiple jobs) ===
          - blktests                        # → 9 jobs (all blktests sections)
          - xfs                             # → 28 jobs (complete XFS coverage)
          - xfs_crc_all                     # → 6 jobs (CRC-enabled only)
          - xfs_nocrc_all                   # → 10 jobs (NOCRC legacy support)
          - xfs_reflink_all                 # → 15 jobs (reflink/CoW only)
          - xfs_lbs_all                     # → 10 jobs (large block size only)

          # === BLKTESTS - Individual Sections ===
          - blktests_block
          - blktests_loop
          - blktests_meta
          - blktests_nbd
          - blktests_nvme
          - blktests_nvmemp
          - blktests_scsi
          - blktests_srp
          - blktests_zbd

          # === XFS - Individual Sections ===
          - xfs_crc
          - xfs_crc_logdev
          - xfs_crc_logdev_rtdev
          - xfs_crc_rtdev
          - xfs_crc_rtdev_extsize_28k
          - xfs_crc_rtdev_extsize_64k
          - xfs_nocrc
          - xfs_nocrc_512
          - xfs_nocrc_1k
          - xfs_nocrc_2k
          - xfs_nocrc_4k
          - xfs_nocrc_8k_4ks
          - xfs_nocrc_16k_4ks
          - xfs_nocrc_32_4ks
          - xfs_nocrc_64_4ks
          - xfs_nocrc_lbs
          - xfs_reflink
          - xfs_reflink_1024
          - xfs_reflink_2k
          - xfs_reflink_4k
          - xfs_reflink_4k_8ks
          - xfs_reflink_8k_4ks
          - xfs_reflink_16k_4ks
          - xfs_reflink_32k_4ks
          - xfs_reflink_64k_4ks
          - xfs_reflink_dir_bsize_8k
          - xfs_reflink_logdev
          - xfs_reflink_normapbt
          - xfs_reflink_stripe_len
          - xfs_reflink_nrext64
          - xfs_reflink_lbs
      kernel_tree:
        description: "Linux kernel tree to use"
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - linux-next
          - linux-stable
      kernel_ref:
        description: "Linux tree git reference (branch/tag/commit-id)"
        required: true
        default: 'master'
        type: string
      test_mode:
        description: 'Testing mode'
        required: false
        default: 'kdevops-ci'
        type: choice
        options:
          - 'kdevops-ci'
          - 'linux-ci'
      tests:
        description: 'Custom test to run (for kdevops-ci mode only)'
        required: false
        type: string
        default: ''

jobs:
  generate_kernel_ref:
    name: Generate Kernel Reference for Scheduled Runs
    runs-on: [self-hosted]
    if: github.event_name == 'schedule'
    outputs:
      kernel_ref: ${{ steps.kernel_ref.outputs.kernel_ref }}
      kernel_tree: ${{ steps.kernel_ref.outputs.kernel_tree }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate kernel reference based on day of week
        id: kernel_ref
        run: |
          set -euxo pipefail
          day_of_week=$(date +%u)

          if [ "$day_of_week" -eq 1 ]; then
            # Monday: Use mainline
            kernel_ref=$(./scripts/korg-releases.py --moniker mainline)
            kernel_tree=linux
          else
            # Other days: Use linux-next
            kernel_ref=$(./scripts/korg-releases.py --moniker linux-next)
            kernel_tree=linux-next
          fi

          ./scripts/github_output.sh kernel_ref "$kernel_ref"
          ./scripts/github_output.sh kernel_tree "$kernel_tree"

  check_ref:
    name: Check Linux kernel Git Reference
    runs-on: [self-hosted]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check kernel_ref exists
        id: check_kernel_ref
        run: |
          set -euxo pipefail

          ref="${{ github.event.inputs.kernel_ref }}"
          tree="${{ github.event.inputs.kernel_tree }}"
          mirror="/mirror/${tree}.git"
          ls_remote="$(git ls-remote "$mirror" "refs/*/${ref}" || true)"
          contains_branch="$(git -C "$mirror" branch --contains "${ref}" || true)"
          contains_tag="$(git -C "$mirror" branch --contains "${ref}" || true)"

          if [ -z "$ls_remote" ] && [ -z "$contains_branch" ] && [ -z "$contains_tag" ]; then
            echo "Linux kernel ${ref} does not exist."
            exit 1
          fi

  expand_workflow:
    name: Determine workflow sections
    runs-on: [self-hosted]
    outputs:
      sections: ${{ steps.expand.outputs.sections }}
      is_expanded: ${{ steps.expand.outputs.is_expanded }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Expand workflow to sections
        id: expand
        run: |
          set -euxo pipefail

          # Get the workflow to expand
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            workflow="blktests"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            workflow="${{ github.event.inputs.ci_workflow }}"
          else
            # Push/PR: use default list
            sections='["blktests_nvme", "xfs_reflink_4k"]'
            ./scripts/github_output.sh sections "$sections"
            ./scripts/github_output.sh is_expanded "false"
            exit 0
          fi

          # Use expansion script
          sections=$(./scripts/expand_workflow_sections.py "$workflow")

          # Determine if this was an expansion (multiple sections)
          section_count=$(echo "$sections" | jq 'length')
          if [ "$section_count" -gt 1 ]; then
            is_expanded="true"
            echo "::notice::Workflow '$workflow' expanded to $section_count sections"
          else
            is_expanded="false"
          fi

          ./scripts/github_output.sh sections "$sections"
          ./scripts/github_output.sh is_expanded "$is_expanded"

  ci-matrix:
    name: "${{ github.event_name == 'schedule' && 'linux-ci' || github.event.inputs.test_mode || 'kdevops-ci' }}: ${{ matrix.ci_workflow }}"
    runs-on: >-
      ${{
        (github.event_name == 'schedule' && fromJSON('["self-hosted", "linux-ci"]')) ||
        (github.event.inputs.test_mode == 'linux-ci' && fromJSON('["self-hosted", "linux-ci"]')) ||
        fromJSON('["self-hosted", "kdevops-ci"]')
      }}
    needs: [check_ref, generate_kernel_ref, expand_workflow]
    if: >-
      always() &&
      (
        needs.check_ref.result == 'success' ||
        needs.check_ref.result == 'skipped'
      ) &&
      (
        needs.generate_kernel_ref.result == 'success' ||
        needs.generate_kernel_ref.result == 'skipped'
      ) &&
      needs.expand_workflow.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        ci_workflow: ${{ fromJSON(needs.expand_workflow.outputs.sections) }}
    steps:
      - name: Checkout repository for ${{ matrix.ci_workflow }}
        shell: bash
        run: |
          set -euxo pipefail

          # Start fresh
          rm -rfv ./* ./.* 2>/dev/null || true

          # Clone repository (with mirror optimization when available)
          if [[ -f "/mirror/kdevops.git/HEAD" ]]; then
            git clone --verbose --progress \
              --reference /mirror/kdevops.git \
              --depth=1 \
              ${{ github.server_url }}/${{ github.repository }}.git .
          else
            git clone --verbose --progress \
              --depth=1 \
              ${{ github.server_url }}/${{ github.repository }}.git .
          fi

          # Checkout the appropriate ref based on event type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch --depth=1 origin refs/pull/${{ github.event.number }}/head:pr-branch
            git checkout pr-branch
          else
            git fetch --depth=1 origin ${{ github.ref }}
            git checkout FETCH_HEAD
          fi

      - name: Report kdevops commit information
        shell: bash
        run: |
          set -euxo pipefail

          # Get current commit info
          commit_sha=$(git rev-parse HEAD)
          commit_short=$(git rev-parse --short HEAD)
          commit_subject=$(git log -1 --pretty=format:"%s")

          # Report the kdevops version used
          echo "::notice title=kdevops Commit::Using kdevops commit $commit_short ($commit_sha): $commit_subject"

          # Also show in regular output for logs
          echo "✅ Running kdevops CI with commit: $commit_short"
          echo "📝 Commit message: $commit_subject"

      - name: Configure kdevops
        uses: ./.github/actions/configure
        with:
          ci_workflow: ${{ matrix.ci_workflow }}
          kernel_ref: >-
            ${{
              github.event_name == 'schedule' && needs.generate_kernel_ref.outputs.kernel_ref
              || github.event.inputs.kernel_ref
              || 'v6.15'
            }}
          kernel_tree: >-
            ${{
              github.event_name == 'schedule' && needs.generate_kernel_ref.outputs.kernel_tree
              || github.event.inputs.kernel_tree
              || 'linux'
            }}
          test_mode: >-
            ${{
              github.event_name == 'schedule' && 'linux-ci'
              || github.event.inputs.test_mode
              || 'kdevops-ci'
            }}

      - name: Bringup guests
        uses: ./.github/actions/bringup

      - name: Install linux
        uses: ./.github/actions/linux

      - name: Install tests
        uses: ./.github/actions/build-test
        with:
          ci_workflow: ${{ matrix.ci_workflow }}

      - name: Run tests
        uses: ./.github/actions/test
        with:
          ci_workflow: ${{ matrix.ci_workflow }}
          test_mode: >-
            ${{
              github.event_name == 'schedule' && 'linux-ci'
              || github.event.inputs.test_mode
              || 'kdevops-ci'
            }}
          tests: ${{ github.event.inputs.tests || '' }}
        timeout-minutes: 120

      - name: Archive results
        uses: ./.github/actions/archive
        with:
          ci_workflow: ${{ matrix.ci_workflow }}
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Cleanup
        if: always()
        uses: ./.github/actions/cleanup
